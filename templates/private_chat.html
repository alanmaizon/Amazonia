<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Private Chat with {{ recipient }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <style>
        #chat {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mt-5">Private Chat with {{ recipient }}</h1>
        <div id="chat"></div>
        <form id="chat-form">
            <div class="input-group mb-3">
                <input type="text" id="message" class="form-control" placeholder="Type a message" required>
                <button type="submit" class="btn btn-primary">Send</button>
            </div>
        </form>
        <button id="close-chat" class="btn btn-danger">Close Chat</button>
    </div>

    <script>
        var socket = io();
        var room = "{{ room }}";

        // Join the room on connection
        socket.emit('join_room', {room: room});

        // Listen for private messages
        socket.on('receive_private_message', function(data) {
            var chat = document.getElementById('chat');
            var messageElement = document.createElement('div');
            messageElement.textContent = data.username + ': ' + data.message;
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight; // Scroll to the bottom
        });

        // Handle form submission for sending messages
        document.getElementById('chat-form').addEventListener('submit', function(event) {
            event.preventDefault();
            var messageInput = document.getElementById('message');
            var message = messageInput.value;
            socket.emit('send_private_message', {message: message, room: room, recipient: "{{ recipient }}"});
            messageInput.value = ''; // Clear the input
        });

        // Listen for users joining the room
        socket.on('user_joined_room', function(data) {
            var chat = document.getElementById('chat');
            var messageElement = document.createElement('div');
            messageElement.classList.add('text-success');
            messageElement.textContent = data.username + ' has joined the chat';
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        });

        // Listen for users leaving the room
        socket.on('user_left_room', function(data) {
            var chat = document.getElementById('chat');
            var messageElement = document.createElement('div');
            messageElement.classList.add('text-danger');
            messageElement.textContent = data.username + ' has left the chat';
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        });

        // Close the chat and leave the room
        document.getElementById('close-chat').addEventListener('click', function() {
            socket.emit('leave_room', {room: room});
            window.location.href = "{{ url_for('home') }}";
        });

        // Ensure the room is left when the user leaves the page
        window.addEventListener('beforeunload', function () {
            socket.emit('leave_room', {room: room});
        });

        // Connect to the socket
        socket.connect();
    </script>
</body>
</html>
